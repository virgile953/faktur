import{r as n,j as t}from"./index-CKBIMJ8Q.js";import{F as z}from"./FilterSelect-B3842IOY.js";import{L as G}from"./components-DqBg-pzF.js";function Z({printers:y,filaments:p,onSubmit:E,initialPrint:d,submitLabel:k=d?"Save Changes":"Create Print",title:I=d?"Edit Print":"Create a New Print"}){const[s,c]=n.useState(d||{name:"",date:new Date,clientId:0,printerUsed:0,filamentsUsed:[],timeToModel:0,timeToPrint:0,timeToPostProcess:0,image:"",filamentsQuantity:[],file:"",usedUpgrades:[],usedConsumables:[]}),[g,N]=n.useState(d?[...d.filamentsUsed]:[]),j=n.useRef(null),[f,$]=n.useState(null),[J,D]=n.useState(d!=null&&d.image?d.image:null),v=n.useRef(null),[h,L]=n.useState(null),[w,R]=n.useState(0),[P,O]=n.useState(0),[x,C]=n.useState(30),[F,M]=n.useState([]),[b,q]=n.useState(0),[S,_]=n.useState(0);n.useEffect(()=>{(async()=>{try{const r=await fetch("/api/electricity");var l=[],a=0;({consos:l,elecPrice:a}=await r.json()),console.log("ElecPrice: ",a),console.log("Consos: ",l),l&&M(l),q(a)}catch(r){console.error("Failed to fetch electricity prices:",r)}})()},[]),n.useEffect(()=>{const e=p.filter(i=>g.includes(i.id)),l=e.map(i=>{const o=s.filamentsUsed.indexOf(i.id);return(o!==-1&&s.filamentsQuantity[o]||0)*(i.price||0)/1e3});R(l.reduce((i,o)=>i+o,0));const a=i=>{const o=s.filamentsUsed.indexOf(i.id);return o!==-1&&s.filamentsQuantity[o]||0},r=e.reduce((i,o)=>i+a(o),0),m=(s.timeToPrint||0)/60;let u=0;e.forEach(i=>{const o=F.find(Q=>Q.filamentType===i.material&&Q.printerId===s.printerUsed);if(!o)return;const T=r>0?a(i)/r:e.length>0?1/e.length:0;u+=m*o.consoKw*b*T/1e3}),O(Number.isFinite(u)?u:0),console.log("Labor Costs: ",x);const U=(s.timeToModel+s.timeToPostProcess)*x/60;_(Number.isFinite(U)?U:0)},[s,F,b,p,g,x]);const K=e=>{if(e.target.files&&e.target.files[0]){const l=e.target.files[0];$(l);const a=new FileReader;a.onload=m=>{var u;(u=m.target)!=null&&u.result&&D(m.target.result)},a.readAsDataURL(l);const r=`${Date.now()}_${l.name}`;c({...s,image:`/prints/imgs/${r}`})}},A=e=>{if(e.target.files&&e.target.files[0]){const l=e.target.files[0];L(l);const a=`${Date.now()}_${l.name}`;c({...s,file:`/prints/files/${a}`})}},B=()=>{E(s,f,h)},H=e=>{if(g.includes(e)){const l=s.filamentsUsed.indexOf(e),a=s.filamentsUsed.filter(m=>m!==e),r=s.filamentsQuantity.filter((m,u)=>u!==l);N(g.filter(m=>m!==e)),c({...s,filamentsUsed:a,filamentsQuantity:r})}else N([...g,e]),c({...s,filamentsUsed:[...s.filamentsUsed,e],filamentsQuantity:[...s.filamentsQuantity,0]})},W=(e,l)=>{const a=s.filamentsUsed.indexOf(e);if(a!==-1){const r=[...s.filamentsQuantity];r[a]=l,c({...s,filamentsQuantity:r})}};return t.jsxs("div",{className:"max-w-7xl mx-auto px-4",children:[t.jsx("h1",{className:" p-2 rounded-lg text-3xl mb-4",children:I}),t.jsxs("div",{className:"border border-gray-700 p-6 rounded-lg grid md:grid-cols-[16rem_70%] gap-4",children:[t.jsxs("label",{className:"flex flex-col gap-1 mb-2",children:["Printer Used",t.jsx(z,{items:y,selectedItem:y.find(e=>e.id===s.printerUsed)||null,setSelectedItem:e=>c({...s,printerUsed:e.id}),showAll:!1,label:"Printer"})]}),t.jsxs("div",{className:"",children:[t.jsx("label",{className:"block mb-2",children:"Filaments Used"}),t.jsx("div",{className:"flex flex-wrap gap-2 max-h-32 overflow-y-auto rounded-lg",children:p.map(e=>t.jsxs("div",{onClick:()=>H(e.id),className:`rounded-lg cursor-pointer flex items-center gap-4 h-12 w-fit pr-3 border border-gray-700 ${g.includes(e.id)?"bg-blue-600":"bg-gray-800"}`,children:[t.jsx("img",{src:`${e.image}`,alt:e.name,className:"h-12 w-12 rounded-l-lg"}),e.name,t.jsx("div",{className:"ml-auto text-gray-400 text-sm",children:e.material}),g.includes(e.id)&&(()=>{const l=s.filamentsUsed.indexOf(e.id),a=l!==-1&&s.filamentsQuantity[l]!==void 0?s.filamentsQuantity[l]:0;return t.jsxs(t.Fragment,{children:[t.jsx("input",{onClick:r=>r.stopPropagation(),value:a,onChange:r=>W(e.id,Number(r.target.value)),min:0,type:"number",className:"text-gray-400 p-2 rounded-lg w-20"}),t.jsx("span",{className:"relative -inset-x-12",children:e.unit})]})})()]},e.id))})]})]}),t.jsxs("div",{className:"border border-gray-700 p-6 rounded-lg grid grid-cols-2 gap-4",children:[t.jsxs("label",{className:"flex flex-col gap-1 mb-2",children:["Print Name",t.jsx("input",{className:"bg-gray-900 rounded-lg pl-2 p-1",type:"text",value:s.name,onChange:e=>c({...s,name:e.target.value}),placeholder:"Enter print name"})]}),t.jsxs("label",{className:"flex flex-col gap-1 mb-2",children:["Client",t.jsx("input",{className:"bg-gray-900 rounded-lg pl-2 p-1",type:"text",value:s.clientId||"",onChange:e=>c({...s,clientId:Number(e.target.value)}),placeholder:"Select client"})]}),t.jsxs("label",{className:"flex flex-col gap-1 mb-2",children:["Print Date",t.jsx("input",{className:"bg-gray-900 rounded-lg pl-2 p-1",type:"date",value:new Date(s.date).toISOString().split("T")[0],onChange:e=>c({...s,date:new Date(e.target.value)})})]}),t.jsxs("label",{className:"flex flex-col gap-1 mb-2",children:["Modelisation Time",t.jsxs("div",{className:"flex flex-row items-center",children:[t.jsx("input",{className:"bg-gray-900 rounded-lg pl-2 p-1 w-full text-right",type:"number",value:s.timeToModel||"",onChange:e=>c({...s,timeToModel:Number(e.target.value)}),placeholder:"0"}),t.jsx("span",{className:"ml-2",children:"minutes"})]})]}),t.jsxs("label",{className:"flex flex-col gap-1 mb-2",children:["Print Time",t.jsxs("div",{className:"flex flex-row items-center",children:[t.jsx("input",{className:"bg-gray-900 rounded-lg pl-2 p-1 w-full text-right",type:"number",value:s.timeToPrint||"",onChange:e=>c({...s,timeToPrint:Number(e.target.value)}),placeholder:"0"}),t.jsx("span",{className:"ml-2",children:"minutes"})]})]}),t.jsxs("label",{className:"flex flex-col gap-1 mb-2",children:["Postprocess Time",t.jsxs("div",{className:"flex flex-row items-center",children:[t.jsx("input",{className:"bg-gray-900 rounded-lg pl-2 p-1 w-full text-right",type:"number",value:s.timeToPostProcess||"",onChange:e=>c({...s,timeToPostProcess:Number(e.target.value)}),placeholder:"0"}),t.jsx("span",{className:"ml-2",children:"minutes"})]})]}),t.jsxs("div",{className:"",children:[t.jsxs("label",{className:"flex flex-col gap-1 mb-2 bg-gray-800 rounded-lg p-2 cursor-pointer",children:["Image",t.jsxs("div",{className:"bg-gray-900 rounded-lg pl-2 p-1 flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-400",children:f?f.name:"Choose a file..."}),t.jsx("button",{type:"button",className:"bg-gray-700 px-3 py-1 rounded",onClick:()=>{var e;return(e=j.current)==null?void 0:e.click()},children:"Browse"})]}),t.jsx("input",{ref:j,className:"hidden",type:"file",accept:"image/*",onChange:K})]}),t.jsxs("label",{className:"flex flex-col gap-1 mb-2 bg-gray-800 rounded-lg p-2 cursor-pointer",children:["Print File",t.jsxs("div",{className:"bg-gray-900 rounded-lg pl-2 p-1 flex items-center justify-between",children:[t.jsx("span",{className:"text-gray-400",children:h?h.name:"Choose a file..."}),t.jsx("button",{type:"button",className:"bg-gray-700 px-3 py-1 rounded",onClick:()=>{var e;return(e=v.current)==null?void 0:e.click()},children:"Browse"})]}),t.jsx("input",{ref:v,className:"hidden",type:"file",accept:".stl,.obj,.3mf,.gcode",onChange:A})]})]}),t.jsxs("label",{className:"block mb-2 w-full",children:["Price estimate",t.jsxs("div",{children:["Filament : ",w,"€"]}),t.jsxs("div",{children:["electricity : ",P.toFixed(2),"€ (at ",b,"€/kWh)"]}),t.jsxs("div",{children:["labor : ",S.toFixed(2),"€"]}),t.jsxs("div",{children:["total : ",(w+P+S).toFixed(2),"€"]}),t.jsxs("label",{className:"p-2 flex flex-col border border-gray-700 rounded-lg m-2",children:[t.jsxs("div",{children:["Hourly rate:",t.jsx("input",{className:"bg-gray-900 rounded-lg mx-2 px-2 p-1 text-right",type:"number",value:x,onChange:e=>C(Number(e.target.value))}),"€/h"]}),t.jsx("input",{className:"w-full rounded-lg p-2 text-right accent-green-500",type:"range",min:"0",max:"100",value:x,onChange:e=>C(Number(e.target.value))})]})]})]}),t.jsxs("div",{className:"flex justify-end gap-4 mt-4",children:[t.jsx(G,{to:"/prints",children:t.jsx("button",{className:"bg-gray-800 text-white px-4 py-2 rounded-lg",children:"Cancel"})}),t.jsx("button",{className:"bg-gradient-to-t from-gray-900 to-gray-800 border border-gray-700 px-4 py-2 rounded-lg",onClick:B,children:k})]})]})}export{Z as N};
